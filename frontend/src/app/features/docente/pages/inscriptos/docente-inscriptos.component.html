<p-toast></p-toast>
<p-button
  label="Volver"
  icon="pi pi-arrow-left"
  class="mb-4"
  (onClick)="goBack()"
></p-button>

<h1 class="text-2xl font-semibold mb-4">
  Inscriptos – Materia #{{ materiaId() }}
</h1>

@if (loading()) {
<p>Cargando...</p>
} @else if (error()) {
<p class="text-red-600">{{ error() }}</p>
} @else { @if (inscriptos().length === 0) {
<p>No hay alumnos inscriptos.</p>
} @else {
<div class="space-y-3">
  @for (a of inscriptos(); track a.alumno_id) {
  <div class="rounded-lg border p-4">
    <div class="font-medium flex items-center justify-between">
      <p>{{ a.apellido }}, {{ a.nombre }}</p>
      <p-button
        label="Agregar calificación"
        icon="pi pi-plus"
        size="small"
        (onClick)="openCreateDialog(a)"
      ></p-button>
    </div>
    <div class="text-sm text-gray-600">{{ a.email }}</div>
    <div class="text-sm mt-2">
      Estado: {{ a.estado }} · Año: {{ a.anio ?? "-" }} · Período:
      {{ a.periodo ?? "-" }}
    </div>
    <div class="mt-4 border-t pt-3">
      <div class="font-medium mb-2">Calificaciones</div>

      @if (!a.calificaciones || a.calificaciones.length === 0) {
      <div class="text-sm text-gray-600">Todavía no hay calificaciones.</div>
      } @else {
      <div class="space-y-2">
        @for (c of a.calificaciones; track c.calificacion_id) {
        <div class="rounded-md bg-gray-50 p-3">
          <div class="text-sm flex items-center justify-between">
            <div>
              <span class="font-medium">{{ c.tipo }}</span>
              · Nota: <span class="font-medium">{{ c.nota }}</span>
            </div>
            <div>
              <p-button
                text
                rounded
                size="small"
                icon="pi pi-pencil"
                pTooltip="Editar calificación"
                [disabled]="saving()"
                (onClick)="openEditDialog(a, c)"
              ></p-button>
            </div>
          </div>

          <div class="text-sm text-gray-600">
            Fecha: {{ c.fecha | date : "short" }}
          </div>

          @if (c.descripcion) {
          <div class="text-sm text-gray-600 mt-1">
            {{ c.descripcion }}
          </div>
          }
        </div>
        }
      </div>
      }
    </div>
  </div>
  }
</div>
} }

<p-dialog
  [modal]="true"
  [style]="{ width: '520px' }"
  [header]="isEditing() ? 'Editar calificación' : 'Agregar calificación'"
  [visible]="dialogVisible()"
  (visibleChange)="dialogVisible.set($event)"
  (onHide)="closeDialog()"
>
  @if (selectedAlumno()) {
  <div class="mb-3 text-sm text-gray-600">
    Alumno:
    <span class="font-medium"
      >{{ selectedAlumno()!.apellido }}, {{ selectedAlumno()!.nombre }}</span
    >
    <div class="text-xs">{{ selectedAlumno()!.email }}</div>
  </div>
  }

  <form [formGroup]="calificacionForm" class="space-y-3">
    <div>
      <label class="block mb-1">Tipo</label>
      <p-dropdown
        class="w-full"
        [options]="tiposCalificacion"
        optionLabel="label"
        optionValue="value"
        formControlName="tipo"
      ></p-dropdown>
    </div>

    <div>
      <label class="block mb-1">Nota</label>
      <p-inputnumber
        class="w-full"
        formControlName="nota"
        mode="decimal"
        locale="es-AR"
        [min]="0"
        [max]="10"
        [minFractionDigits]="0"
        [maxFractionDigits]="2"
      ></p-inputnumber>
    </div>

    <div class="flex flex-col gap-2 w-full">
      <label>Fecha</label>
      <p-datepicker
        appendTo="body"
        styleClass="w-full"
        formControlName="fecha"
        [showIcon]="true"
      />
    </div>

    <div>
      <label class="block mb-1">Descripción (opcional)</label>
      <textarea
        pTextarea
        formControlName="descripcion"
        [fluid]="true"
        [maxlength]="150"
      ></textarea>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button
        label="Cancelar"
        severity="secondary"
        [disabled]="saving()"
        (onClick)="closeDialog()"
      ></p-button>

      <p-button
        label="Guardar"
        icon="pi pi-check"
        [disabled]="calificacionForm.invalid || saving()"
        (onClick)="saveCalificacion()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>
